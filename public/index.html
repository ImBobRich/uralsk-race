<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—Ä–∞–ª—å—Å–∫–∏–µ –°–∫–∞—á–∫–∏</title>
    <style>
        body { margin: 0; font-family: 'Arial', sans-serif; background: #2d5a27; color: white; overflow: hidden; }
        /* –≠–∫—Ä–∞–Ω –∏–ø–ø–æ–¥—Ä–æ–º–∞ */
        #stadium { display: none; width: 100vw; height: 100vh; flex-direction: column; }
        .lane { flex: 1; border-bottom: 2px dashed rgba(255,255,255,0.3); position: relative; display: flex; align-items: center; padding-left: 20px; }
        .horse { position: absolute; font-size: 3rem; transition: left 0.1s linear; white-space: nowrap; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); }
        .horse-name { font-size: 1rem; display: block; text-align: center; background: rgba(0,0,0,0.6); padding: 2px 5px; border-radius: 4px; }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–π –ø—É–ª—å—Ç */
        #mobile { display: none; height: 100vh; text-align: center; background: #1a1a1a; padding: 20px; box-sizing: border-box; }
        .shake-btn { width: 200px; height: 200px; border-radius: 50%; border: none; background: radial-gradient(#ff416c, #ff4b2b); color: white; font-weight: bold; font-size: 1.5rem; box-shadow: 0 0 20px #ff4b2b; margin-top: 50px; cursor: pointer; }
        .ready-btn { padding: 15px 40px; font-size: 1.2rem; background: #4CAF50; color: white; border: none; border-radius: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="stadium">
        <div style="background: rgba(0,0,0,0.5); padding: 10px; text-align: center;">
            <h1 style="margin:0;">–°–û–õ–¨–ù–ê–õ–¨: –£–†–ê–õ–¨–°–ö–ò–ï –°–ö–ê–ß–ö–ò</h1>
        </div>
        <div id="tracks" style="flex:1; position:relative;"></div>
    </div>

    <div id="mobile">
        <div id="setup">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∂–æ–∫–µ—è</h2>
            <input type="text" id="pName" placeholder="–ò–º—è –ª–æ—à–∞–¥–∏" style="padding:15px; width:80%; font-size:1.2rem; border-radius:8px; border:none;"><br>
            <button class="ready-btn" onclick="goReady()">–Ø –ì–û–¢–û–í!</button>
        </div>
        <div id="race-ui" style="display:none;">
            <h2 id="status">–ñ–î–ï–ú –°–¢–ê–†–¢–ê...</h2>
            <button class="shake-btn" id="shakeBtn">–¢–†–Ø–°–ò –¢–ï–õ–ï–§–û–ù!</button>
            <p style="margin-top:20px; color:#aaa;">–ò–ª–∏ –±—ã—Å—Ç—Ä–æ –Ω–∞–∂–∏–º–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const isScreen = urlParams.has('screen'); // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ ?screen –≤ —Å—Å—ã–ª–∫–µ

        if (isScreen) {
            document.getElementById('stadium').style.display = 'flex';
        } else {
            document.getElementById('mobile').style.display = 'block';
        }

        function goReady() {
            const name = document.getElementById('pName').value || "–ê–Ω–æ–Ω–∏–º";
            socket.emit('join', { name: name });
            document.getElementById('setup').style.display = 'none';
            document.getElementById('race-ui').style.display = 'block';
        }

        // –õ–æ–≥–∏–∫–∞ —Ç—Ä—è—Å–∫–∏ (–∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä)
        let lastShake = 0;
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', (event) => {
                let acc = event.accelerationIncludingGravity;
                let speed = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
                if (speed > 25) { // –ü–æ—Ä–æ–≥ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    let now = Date.now();
                    if (now - lastShake > 100) { // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
                        socket.emit('shake');
                        lastShake = now;
                        visualFeedback();
                    }
                }
            });
        }

        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –∫–ª–∏–∫
        document.getElementById('shakeBtn').addEventListener('click', () => {
            socket.emit('shake');
            visualFeedback();
        });

        function visualFeedback() {
            const btn = document.getElementById('shakeBtn');
            btn.style.transform = "scale(1.1)";
            setTimeout(() => btn.style.transform = "scale(1)", 50);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ø–ø–æ–¥—Ä–æ–º–∞
        socket.on('updatePlayers', (players) => {
            if (!isScreen) return;
            const tracks = document.getElementById('tracks');
            tracks.innerHTML = '';
            
            let i = 0;
            for (let id in players) {
                const p = players[id];
                const lane = document.createElement('div');
                lane.className = 'lane';
                lane.innerHTML = `
                    <div class="horse" style="left: ${Math.min(p.pos, 90)}vw;">
                        <span class="horse-name">${p.name}</span>
                        üêé
                    </div>
                `;
                tracks.appendChild(lane);
                i++;
            }
        });
    </script>
</body>
</html>
