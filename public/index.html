<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—Ä–∞–ª—å—Å–∫–∏–µ –°–∫–∞—á–∫–∏ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --kr-gold: #ffd700; --kr-red: #b22222; }
        body { margin: 0; padding: 0; background: #222; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; }

        /* –≠–ö–†–ê–ù–´ */
        #lobby, #stadium, #victory-screen, #mobile { display: none; width: 100vw; height: 100vh; }
        
        /* LOBBY */
        #lobby { flex-direction: column; align-items: center; justify-content: center; background: #4a0000; }
        .qr-box { background: white; padding: 15px; border-radius: 10px; }
        #team-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .team-tag { background: var(--kr-gold); color: #000; padding: 10px 20px; border-radius: 5px; font-weight: bold; }

        /* –ü–õ–û–°–ö–ò–ô –°–¢–ê–î–ò–û–ù */
        #stadium { background: #2d5a27; flex-direction: column; }
        #race-field { flex: 1; display: flex; flex-direction: column; padding: 20px 0; box-sizing: border-box; }
        
        .track-lane {
            flex: 1; border-top: 2px dashed rgba(255,255,255,0.3); border-bottom: 2px dashed rgba(255,255,255,0.3);
            position: relative; background: rgba(0,0,0,0.1); display: flex; align-items: center;
        }
        .finish-line {
            position: absolute; right: 50px; top: 0; bottom: 0; width: 40px;
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
            border-left: 5px solid gold;
        }

        /* –£–ß–ê–°–¢–ù–ò–ö */
        .horse-unit {
            position: absolute; left: 0; display: flex; align-items: center;
            transition: left 0.3s ease-out; margin-left: 20px;
        }
        .horse-img { font-size: 4rem; filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.5)); }
        .horse-info { 
            background: white; color: black; padding: 5px 10px; border-radius: 5px; 
            font-size: 1rem; margin-left: 10px; white-space: nowrap; font-weight: bold;
        }

        /* –û–¢–°–ß–ï–¢ */
        #countdown-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center;
            font-size: 20rem; color: var(--kr-gold); z-index: 5000;
        }

        /* –ü–û–ë–ï–î–ê (–° –§–ï–ô–ï–†–í–ï–†–ö–û–ú) */
        #victory-screen { 
            flex-direction: column; align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.95); z-index: 9999; text-align: center;
        }
        .firework-text { font-size: 5rem; color: gold; animation: blink 0.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* –ú–û–ë–ò–õ–ö–ê */
        #mobile { text-align: center; padding: 20px; background: #1b5e20; box-sizing: border-box; }
        .m-input { width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; border-radius: 10px; border: none; }
        #energy-bar { width: 100%; height: 40px; background: #222; border: 3px solid white; border-radius: 20px; overflow: hidden; margin: 20px 0; }
        #energy-fill { width: 0%; height: 100%; background: gold; transition: 0.1s; }
        
        #admin-panel { position: fixed; bottom: 10px; left: 10px; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color: var(--kr-gold); font-size: 3rem; margin: 0;">–£–†–ê–õ–¨–°–ö–ò–ï –°–ö–ê–ß–ö–ò 2026</h1>
        <div class="qr-box" id="player-qr"></div>
        <div id="team-list"></div>
    </div>

    <div id="stadium">
        <div id="race-field">
            </div>
        <div id="countdown-overlay">5</div>
    </div>

    <div id="victory-screen">
        <div class="firework-text">üéâ –ü–û–ë–ï–î–ê üéâ</div>
        <div id="winner-name" style="font-size: 6rem; color: white;"></div>
        <button onclick="socket.emit('restart')" style="padding: 20px 50px; font-size: 1.5rem; margin-top: 30px; cursor: pointer; border-radius: 10px; background: gold;">–ö –ù–ê–ß–ê–õ–£</button>
    </div>

    <div id="mobile">
        <div id="m-setup">
            <h2 style="color: gold;">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –°–¢–û–õ–ê</h2>
            <input type="number" id="m-table" class="m-input" placeholder="–ù–û–ú–ï–† –°–¢–û–õ–ê">
            <input type="text" id="m-name" class="m-input" placeholder="–ù–ê–ó–í–ê–ù–ò–ï –ö–û–ú–ê–ù–î–´">
            <button onclick="mJoin()" style="padding: 20px; width: 100%; background: gold; border: none; font-weight: bold; border-radius: 10px; font-size: 1.5rem;">–ì–û–¢–û–í</button>
        </div>
        <div id="m-race" style="display:none;">
            <h2 id="m-team-display" style="color: gold;"></h2>
            <div id="energy-bar"><div id="energy-fill"></div></div>
            <p id="m-status" style="font-size: 1.5rem;">–ñ–î–ï–ú –°–¢–ê–†–¢–ê...</p>
        </div>
    </div>

    <div id="admin-panel"><button onclick="socket.emit('adminStartCountdown')" style="padding: 15px 30px; background: red; color: white; border-radius: 10px; border: none; font-weight: bold;">–ü–£–°–ö</button></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const isAdmin = params.has('admin'), isScreen = params.has('screen');
        const socket = io({ query: { admin: isAdmin } });

        if (isScreen) {
            document.getElementById('lobby').style.display = 'flex';
            new QRCode(document.getElementById("player-qr"), window.location.origin);
        } else {
            document.getElementById('mobile').style.display = 'block';
        }
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';

        function mJoin() {
            const tableId = document.getElementById('m-table').value;
            const teamName = document.getElementById('m-name').value;
            if(!tableId) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–ª");
            socket.emit('join', { tableId, teamName });
            document.getElementById('m-setup').style.display = 'none';
            document.getElementById('m-race').style.display = 'block';
            document.getElementById('m-team-display').innerText = teamName || "–°—Ç–æ–ª "+tableId;

            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') DeviceMotionEvent.requestPermission();
            window.addEventListener('devicemotion', (e) => {
                let a = e.accelerationIncludingGravity;
                if (Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z) > 25) {
                    socket.emit('shake');
                    document.getElementById('energy-fill').style.width = '100%';
                    setTimeout(() => document.getElementById('energy-fill').style.width = '0%', 100);
                }
            });
        }

        socket.on('updateState', (state) => {
            if (isScreen) {
                if (state.status === 'LOBBY') {
                    document.getElementById('lobby').style.display = 'flex';
                    document.getElementById('stadium').style.display = 'none';
                    document.getElementById('victory-screen').style.display = 'none';
                    document.getElementById('team-list').innerHTML = Object.values(state.tables).map(t => `<div class="team-tag">${t.name}</div>`).join('');
                } else {
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('stadium').style.display = 'flex';
                    
                    const overlay = document.getElementById('countdown-overlay');
                    if (state.status === 'COUNTDOWN') {
                        overlay.style.display = 'flex';
                        overlay.innerText = state.countdown;
                    } else {
                        overlay.style.display = 'none';
                    }
                    renderRace(state.tables);
                }
            } else {
                document.getElementById('m-status').innerText = state.status === 'RACING' ? "–¢–†–Ø–°–ò –¢–ï–õ–ï–§–û–ù!!!" : (state.status === 'COUNTDOWN' ? "–ü–†–ò–ì–û–¢–û–í–ò–¢–¨–°–Ø..." : "–ñ–î–ï–ú –°–¢–ê–†–¢–ê...");
            }
        });

        function renderRace(tables) {
            const field = document.getElementById('race-field');
            field.innerHTML = ''; // –û—á–∏—â–∞–µ–º –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            
            Object.values(tables).forEach(t => {
                const lane = document.createElement('div');
                lane.className = 'track-lane';
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é (–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è —Ñ–∏–Ω–∏—à–Ω–æ–π —á–µ—Ä—Ç—ã)
                const horsePos = t.score * 0.85; 

                lane.innerHTML = `
                    <div class="finish-line"></div>
                    <div class="horse-unit" style="left: ${horsePos}%">
                        <div class="horse-img">üèá</div>
                        <div class="horse-info">${t.name}</div>
                    </div>
                `;
                field.appendChild(lane);
            });
        }

        socket.on('winner', (d) => {
            if (isScreen) {
                document.getElementById('victory-screen').style.display = 'flex';
                document.getElementById('winner-name').innerText = d.name;
            }
        });
        socket.on('gameRestarted', () => location.reload());
    </script>
</body>
</html>
