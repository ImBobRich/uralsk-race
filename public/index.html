<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–û–õ–õ–ê–õ–¨ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --gold: #ffd700; --check: 40px; }
        body { margin: 0; background: #000; font-family: 'Arial Black', sans-serif; color: white; overflow: hidden; touch-action: none; }
        .page { display: none; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; box-sizing: border-box; }
        
        /* –¢–í –õ–û–ë–ë–ò */
        #lobby { flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); }
        .qr-area { background: white; padding: 20px; border-radius: 20px; border: 10px solid var(--gold); }
        .info-plate { background: rgba(255,255,255,0.05); padding: 30px; border: 2px solid var(--gold); border-radius: 20px; font-size: 2rem; }

        /* –¢–í –¢–†–ê–°–°–ê */
        #stadium { background: #1a3c15; flex-direction: column; }
        .lane { flex: 1; border-bottom: 2px solid rgba(255,255,255,0.1); position: relative; display: flex; align-items: center; }
        
        .finish-line {
            position: absolute; right: 0; top: 0; bottom: 0; width: 100px;
            background-image: 
                linear-gradient(45deg, #000 25%, transparent 25%), 
                linear-gradient(-45deg, #000 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #000 75%),
                linear-gradient(-45deg, transparent 75%, #000 75%);
            background-size: var(--check) var(--check); background-color: #fff;
            background-position: 0 0, 0 20px, 20px -20px, -20px 0px;
            border-left: 5px solid var(--gold); z-index: 1;
        }

        .horse { position: absolute; left: 0; transition: left 0.15s ease-out; z-index: 10; display: flex; align-items: center; }
        .horse-img { font-size: 6rem; transform: scaleX(-1); animation: gallop 0.4s infinite alternate; }
        @keyframes gallop { from { transform: translateY(0) scaleX(-1); } to { transform: translateY(-25px) scaleX(-1); } }
        .horse-name { background: var(--gold); color: #000; padding: 5px 15px; border-radius: 10px; font-size: 1.5rem; margin-left: -10px; border: 3px solid #000; }

        /* –ê–î–ú–ò–ù–ö–ê */
        #admin { background: #111; display: none; flex-direction: column; align-items: center; padding: 20px; }
        .adm-panel { background: #222; border: 2px solid var(--gold); border-radius: 20px; padding: 30px; width: 90%; max-width: 600px; }
        .adm-input-row { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; }
        .adm-input-row input { width: 70px; padding: 10px; font-size: 1.5rem; text-align: center; border-radius: 10px; }
        .btn-start { width: 100%; padding: 30px; font-size: 2.5rem; background: #2e7d32; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .btn-start:disabled { background: #444; cursor: not-allowed; }
        #adm-stats { margin-top: 20px; font-size: 1.2rem; background: #000; padding: 15px; border-radius: 10px; line-height: 1.6; }

        /* –ú–û–ë–ò–õ–ö–ê */
        #mobile { background: #1b5e20; padding: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .table-btn { padding: 20px; background: #fff; color: #000; border-radius: 15px; font-size: 1.3rem; border: 5px solid transparent; font-weight: bold; }
        .table-btn.selected { border-color: var(--gold); background: #ffeb3b; }
        .table-btn.disabled { opacity: 0.3; pointer-events: none; }
        .m-input { width: 100%; padding: 20px; border-radius: 15px; border: none; font-size: 1.4rem; margin-bottom: 20px; box-sizing: border-box; }

        #victory { background: rgba(0,0,0,0.95); flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    </style>
</head>
<body>
    <audio id="fanfare" src="https://actions.google.com/sounds/v1/human_voices/applause_clapping_and_cheering.ogg"></audio>

    <div id="lobby" class="page">
        <h1 style="font-size: 6rem; color: var(--gold); margin: 0 0 20px 0;">–°–û–õ–õ–ê–õ–¨ 2026</h1>
        <div class="main-row">
            <div class="qr-area"><div id="qrcode"></div></div>
            <div class="info-plate">
                <h2 style="color:var(--gold); margin-top:0;">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø:</h2>
                1. –°–∫–∞–Ω–∏—Ä—É–π QR-–∫–æ–¥<br>
                2. –í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Å–≤–æ–µ–≥–æ —Å—Ç–æ–ª–∞<br>
                3. –ñ–¥–∏ –∫–æ–º–∞–Ω–¥—ã "–°–¢–ê–†–¢" –∏ —Ç—Ä—è—Å–∏!
            </div>
        </div>
        <div id="lobby-list" style="margin-top: 40px; display: flex; gap: 20px;"></div>
    </div>

    <div id="stadium" class="page">
        <div id="track-container" style="flex: 1; display: flex; flex-direction: column;"></div>
        <div id="stats-line" style="height: 100px; background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 4px solid var(--gold);"></div>
        <div id="countdown-overlay" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30rem; color: var(--gold); display: none; text-shadow: 0 0 50px #000;">5</div>
    </div>

    <div id="victory" class="page">
        <h1 style="color:red; font-size: 12rem; margin: 0; text-shadow: 0 0 40px red;">–§–ò–ù–ò–®</h1>
        <h2 style="font-size: 5rem;">–ü–û–ë–ï–î–ò–¢–ï–õ–¨: <span id="winner-display" style="color:var(--gold);"></span></h2>
        <button onclick="socket.emit('restart')" style="padding: 20px 50px; font-size: 2rem; background: var(--gold); border-radius: 15px; border: none; font-weight: bold; cursor: pointer;">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <div id="mobile" class="page">
        <div id="m-join">
            <h2 style="color:var(--gold); font-size: 2.5rem;">–í–´–ë–ï–†–ò –°–¢–û–õ:</h2>
            <div id="table-grid" class="grid"></div>
            <input type="text" id="team-name" class="m-input" placeholder="–ò–º—è –∫–æ–º–∞–Ω–¥—ã">
            <button onclick="requestJoin()" style="width:100%; padding:25px; background:var(--gold); font-size:2rem; border-radius:20px; border:none; font-weight:bold;">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
        </div>
        <div id="m-shake" class="page" style="flex-direction: column; align-items: center; justify-content: center;">
            <h1 style="font-size: 6rem; color: var(--gold); margin: 0;">–¢–†–Ø–°–ò!</h1>
            <div style="font-size: 15rem;">üèá</div>
        </div>
    </div>

    <div id="admin" class="page">
        <div class="adm-panel">
            <h1 style="color:var(--gold); text-align: center; margin-top:0;">–ê–î–ú–ò–ù-–¶–ï–ù–¢–†</h1>
            <div class="adm-input-row">
                <div>–°–¢–û–õ–û–í: <input type="number" id="cfg-t" value="7"></div>
                <div>–õ–ò–ú–ò–¢: <input type="number" id="cfg-l" value="3"></div>
                <button onclick="saveCfg()" style="background:var(--gold); padding: 10px 20px; border-radius: 10px; border:none; font-weight:bold;">OK</button>
            </div>
            <button id="btn-start-race" class="btn-start" onclick="socket.emit('adminStartCountdown')" disabled>–°–¢–ê–†–¢ –ò–ì–†–´</button>
            <div id="adm-stats">–ö–æ–º–∞–Ω–¥—ã –Ω–µ –≥–æ—Ç–æ–≤—ã...</div>
            <center><button onclick="if(confirm('–°–ë–†–û–°–ò–¢–¨ –í–°–Å?')) socket.emit('restart')" style="margin-top: 30px; background: none; color: red; border: 1px solid red; padding: 10px; cursor: pointer;">–°–ë–†–û–°–ò–¢–¨ –°–ï–°–°–ò–Æ</button></center>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        const isTV = params.has('screen');
        const isAdmin = params.has('admin');

        let selectedTableId = null;
        let hasJoined = false;

        if (isTV) {
            document.getElementById('lobby').style.display = 'flex';
            new QRCode(document.getElementById("qrcode"), { text: window.location.origin, width: 350, height: 350 });
            window.onclick = () => document.getElementById('fanfare').load();
        } else if (isAdmin) {
            document.getElementById('admin').style.display = 'flex';
        } else {
            document.getElementById('mobile').style.display = 'block';
        }

        function saveCfg() {
            socket.emit('adminConfig', {
                totalTables: document.getElementById('cfg-t').value,
                maxPlayers: document.getElementById('cfg-l').value
            });
        }

        async function requestJoin() {
            if (!selectedTableId) return alert("–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞!");
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const res = await DeviceMotionEvent.requestPermission();
                if (res !== 'granted') return alert("–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º!");
            }
            socket.emit('join', { tableId: selectedTableId, teamName: document.getElementById('team-name').value });
        }

        socket.on('joinSuccess', () => {
            hasJoined = true;
            document.getElementById('m-join').style.display = 'none';
            document.getElementById('m-shake').style.display = 'flex';
        });

        socket.on('updateState', (state) => {
            if (isAdmin) {
                const count = Object.keys(state.tables).length;
                document.getElementById('btn-start-race').disabled = count === 0 || state.status !== 'LOBBY';
                document.getElementById('adm-stats').innerHTML = `<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–æ —Å—Ç–æ–ª–æ–≤: ${count}</b><br>` + 
                    Object.values(state.tables).map(t => `–°—Ç–æ–ª ${t.id}: ${t.name} (üë• ${t.count}/${state.maxPlayersPerTable})`).join('<br>');
            }

            if (!isTV && !isAdmin && !hasJoined) {
                const grid = document.getElementById('table-grid');
                grid.innerHTML = '';
                for (let i = 1; i <= state.totalTables; i++) {
                    const t = state.tables[i];
                    let btn = document.createElement('div');
                    btn.className = `table-btn ${t && t.count >= state.maxPlayersPerTable ? 'disabled' : ''} ${selectedTableId == i ? 'selected' : ''}`;
                    btn.innerText = `–°–¢–û–õ ${i}`;
                    btn.onclick = () => { selectedTableId = i; socket.emit('updateState', state); };
                    grid.appendChild(btn);
                }
            }

            if (isTV) {
                if (state.status === 'LOBBY') {
                    document.getElementById('lobby').style.display = 'flex';
                    document.getElementById('stadium').style.display = 'none';
                    document.getElementById('victory').style.display = 'none';
                    document.getElementById('lobby-list').innerHTML = Object.values(state.tables)
                        .map(t => `<div style="background:var(--gold); color:#000; padding:15px; border-radius:12px; font-weight:bold; font-size:1.5rem;">${t.name} (üë• ${t.count})</div>`).join('');
                } else if (state.status === 'FINISHED') {
                    document.getElementById('victory').style.display = 'flex';
                    document.getElementById('winner-display').innerText = state.winner;
                    document.getElementById('fanfare').play();
                } else {
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('stadium').style.display = 'flex';
                    const overlay = document.getElementById('countdown-overlay');
                    overlay.style.display = state.status === 'COUNTDOWN' ? 'block' : 'none';
                    overlay.innerText = state.countdown;

                    const tracks = document.getElementById('track-container');
                    const stats = document.getElementById('stats-line');
                    if (state.status === 'COUNTDOWN' && state.countdown === 5) { tracks.innerHTML = ''; stats.innerHTML = ''; }

                    Object.values(state.tables).forEach(t => {
                        let h = document.getElementById('h-' + t.id);
                        if (!h) {
                            tracks.insertAdjacentHTML('beforeend', `
                                <div class="lane">
                                    <div class="finish-line"></div>
                                    <div id="h-${t.id}" class="horse">
                                        <div class="horse-img">üèá</div>
                                        <div class="horse-name">${t.name}</div>
                                    </div>
                                </div>`);
                            h = document.getElementById('h-' + t.id);
                        }
                        h.style.left = (t.score * 0.88) + '%';
                        
                        let s = document.getElementById('s-' + t.id);
                        if (!s) stats.insertAdjacentHTML('beforeend', `<div id="s-${t.id}" style="text-align:center;"><b>${t.name}</b><br>üë• ${t.count} | ${Math.floor(t.score)}%</div>`);
                        else s.innerHTML = `<b>${t.name}</b><br>üë• ${t.count} | ${Math.floor(t.score)}%`;
                    });
                }
            }
        });

        socket.on('gameRestarted', () => location.reload());

        // –ù–ê–î–ï–ñ–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–†–Ø–°–ö–ò
        let lastShake = 0;
        window.addEventListener('devicemotion', (e) => {
            if (!hasJoined) return;
            const acc = e.accelerationIncludingGravity;
            const totalAcc = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
            const now = Date.now();
            if (totalAcc > 25 && (now - lastShake > 80)) {
                socket.emit('shake');
                lastShake = now;
            }
        });
    </script>
</body>
</html>
