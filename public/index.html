<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—Ä–∞–ª—å—Å–∫–∏–µ –°–∫–∞—á–∫–∏ 2026</title>
    <style>
        :root {
            --lane-red: #ff4d4d; --lane-blue: #4d94ff; --lane-white: #eeeeee; 
            --lane-yellow: #ffdb4d; --lane-purple: #b366ff; --lane-orange: #ff944d;
        }
        body { margin: 0; padding: 0; background: #000; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; }

        /* –≠–ö–†–ê–ù –¢–í */
        #stadium { display: none; width: 100vw; height: 100vh; flex-direction: column; background: #1a3317; }
        #header { 
            height: 12%; background: rgba(0,0,0,0.9); display: flex; 
            justify-content: space-around; align-items: center; border-bottom: 4px solid gold; z-index: 20;
        }
        #race-field {
            flex: 1; position: relative; overflow: hidden;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 30%, #ffffff 35%, #2d5a27 35%);
        }

        /* –î–æ—Ä–æ–∂–∫–∏ */
        #tracks-layer {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 65%; display: flex;
            clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
            background: #444; border-top: 10px solid white;
        }
        .lane { flex: 1; border-right: 3px solid rgba(255,255,255,0.4); position: relative; }
        .lane:nth-child(1) { background: var(--lane-red); }
        .lane:nth-child(2) { background: var(--lane-blue); }
        .lane:nth-child(3) { background: var(--lane-white); }
        .lane:nth-child(4) { background: var(--lane-yellow); }
        .lane:nth-child(5) { background: var(--lane-purple); }
        .lane:nth-child(6) { background: var(--lane-orange); }

        /* –õ–æ—à–∞–¥–∏ */
        .horse {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            transition: bottom 0.1s linear, left 0.3s ease-out; z-index: 10;
        }
        .horse-emoji { font-size: 6rem; transform: scaleX(-1); filter: drop-shadow(0 15px 5px rgba(0,0,0,0.4)); }
        .horse-label { 
            background: gold; color: black; padding: 5px 15px; border-radius: 8px; 
            font-size: 1.2rem; border: 3px solid black; white-space: nowrap; font-weight: bold;
        }

        #stats-panel {
            position: absolute; top: 20px; right: 20px; width: 300px;
            background: rgba(0,0,0,0.8); border: 3px solid gold; padding: 15px; border-radius: 15px; z-index: 30;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: gold; font-size: 1.2rem; border-bottom: 1px solid #444; }

        /* –ú–û–ë–ò–õ–¨–ù–´–ô –ü–£–õ–¨–¢ */
        #mobile { display: none; height: 100vh; background: #1b5e20; text-align: center; }
        .setup-input { padding: 15px; width: 80%; font-size: 1.2rem; margin: 10px 0; border-radius: 10px; border: none; text-align: center; }
        
        .energy-bar-container { 
            width: 85%; height: 50px; background: #222; border-radius: 25px; 
            margin: 30px auto; border: 4px solid white; overflow: hidden; position: relative;
        }
        #energy-fill { 
            width: 0%; height: 100%; 
            background: linear-gradient(90deg, #ffeb3b, #ff9800, #ff5722); 
            box-shadow: 0 0 20px #ff5722; transition: width 0.1s; 
        }

        #btn-ready { background: #4CAF50; padding: 25px 60px; font-size: 2rem; border-radius: 20px; color: white; border: none; cursor: pointer; }
        #btn-shake { 
            width: 220px; height: 220px; border-radius: 50%; background: #ff9800; 
            font-size: 2rem; border: 10px solid white; color: white; font-weight: bold;
            box-shadow: 0 10px 0 #e65100; active: transform: translateY(5px);
        }

        @keyframes jump { 0%, 100% { transform: scaleX(-1) translateY(0); } 50% { transform: scaleX(-1) translateY(-20px); } }
        .moving .horse-emoji { animation: jump 0.3s infinite; }
    </style>
</head>
<body>

    <div id="stadium">
        <div id="header">
            <h1 style="color: gold; margin: 0; text-shadow: 2px 2px 0 #000;">–°–û–õ–¨–ù–ê–õ–¨ 2026: –£–†–ê–õ–¨–°–ö–ò–ï –°–ö–ê–ß–ö–ò</h1>
            <div id="timer" style="font-size: 3rem; font-family: monospace;">00:03</div>
        </div>
        <div id="race-field">
            <div id="tracks-layer">
                <div class="lane"></div><div class="lane"></div><div class="lane"></div>
                <div class="lane"></div><div class="lane"></div><div class="lane"></div>
            </div>
            <div id="horses-container" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 65%;"></div>
            <div id="stats-panel">
                <h2 style="margin:0 0 10px 0; color: white; text-align: center;">–†–ï–ô–¢–ò–ù–ì –°–¢–û–õ–û–í</h2>
                <div id="live-ranks"></div>
            </div>
        </div>
    </div>

    <div id="mobile">
        <div id="setup" style="padding-top: 40px;">
            <h1 style="font-size: 2.5rem;">–í–ê–® –°–¢–û–õ?</h1>
            <input type="number" id="tableNum" class="setup-input" placeholder="–ù–û–ú–ï–† –°–¢–û–õ–ê (1-7)">
            <input type="text" id="teamName" class="setup-input" placeholder="–ù–ê–ó–í–ê–ù–ò–ï –ö–û–ú–ê–ù–î–´">
            <p style="padding: 10px 20px;">–ï—Å–ª–∏ –≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞, –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞.</p>
            <button id="btn-ready" onclick="join()">–ü–û–ì–ù–ê–õ–ò!</button>
        </div>

        <div id="race-ui" style="display:none; padding-top: 30px;">
            <h1 id="ui-team-name" style="color: gold; margin-bottom: 0;">–ö–û–ú–ê–ù–î–ê</h1>
            <p>–ñ–ú–ò –ò –¢–†–Ø–°–ò –¢–ï–õ–ï–§–û–ù!</p>
            <div class="energy-bar-container"><div id="energy-fill"></div></div>
            <button id="btn-shake">–¢–†–Ø–°–ò!</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const isScreen = new URLSearchParams(window.location.search).has('screen');
        let canShake = true;

        if (isScreen) document.getElementById('stadium').style.display = 'flex';
        else document.getElementById('mobile').style.display = 'block';

        async function join() {
            const tableId = document.getElementById('tableNum').value;
            const teamName = document.getElementById('teamName').value;
            
            if (!tableId) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞!");

            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                await DeviceMotionEvent.requestPermission();
            }

            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity;
                let totalAcc = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
                if (totalAcc > 25) throttleShake();
            });

            socket.emit('join', { tableId, teamName });
            document.getElementById('setup').style.display = 'none';
            document.getElementById('race-ui').style.display = 'block';
            document.getElementById('ui-team-name').innerText = teamName || `–°–¢–û–õ ‚Ññ${tableId}`;
        }

        function throttleShake() {
            if (!canShake) return;
            shake();
            canShake = false;
            setTimeout(() => { canShake = true; }, 100); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
        }

        function shake() {
            socket.emit('shake');
            const fill = document.getElementById('energy-fill');
            fill.style.width = '100%';
            setTimeout(() => { fill.style.width = '0%'; }, 150);
        }
        document.getElementById('btn-shake').onclick = throttleShake;

        socket.on('updatePlayers', (tables) => {
            if (!isScreen) return;
            const container = document.getElementById('horses-container');
            const ranks = document.getElementById('live-ranks');
            container.innerHTML = '';
            ranks.innerHTML = '';

            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const sortedTables = Object.entries(tables).sort((a, b) => b[1].score - a[1].score);

            sortedTables.forEach(([id, data], index) => {
                const laneIdx = (parseInt(id) - 1) % 6; // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ 6 –¥–æ—Ä–æ–∂–∫–∞–º
                const progress = data.score / 100;
                
                // –†–∞—Å—á–µ—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
                const laneWidth = 100 / 6;
                const startX = (laneIdx + 0.5) * laneWidth;
                const endX = 20 + (laneIdx + 0.5) * 10; // –ö–æ—Ä–∏–¥–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –∫ 60% —à–∏—Ä–∏–Ω—ã
                const currentX = startX + (endX - startX) * progress;

                const horse = document.createElement('div');
                horse.className = `horse ${data.score > 0 ? 'moving' : ''}`;
                horse.style.left = `${currentX}%`;
                horse.style.bottom = `${data.score}%`;
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ—Ç 1.5 –¥–æ 0.6
                horse.style.transform = `translateX(-50%) scale(${1.5 - (progress * 0.9)})`;
                horse.style.zIndex = Math.floor(100 - data.score);
                
                horse.innerHTML = `
                    <div class="horse-label">${data.name}</div>
                    <div class="horse-emoji">üèá</div>
                `;
                container.appendChild(horse);

                ranks.innerHTML += `
                    <div class="stat-row">
                        <span>${data.name}</span>
                        <span>${Math.floor(data.score)}%</span>
                    </div>
                `;
            });
        });

        socket.on('winner', (data) => {
            alert("–ü–û–ë–ï–î–ò–¢–ï–õ–¨: " + data.name);
            setTimeout(() => { socket.emit('restart'); }, 5000);
        });

        socket.on('gameRestarted', () => { location.reload(); });
    </script>
</body>
</html>
