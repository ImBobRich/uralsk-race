<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—Ä–∞–ª—å—Å–∫–∏–µ –°–∫–∞—á–∫–∏ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --kr-red: #b22222; --kr-gold: #ffd700;
            --lane-1: #ff4d4d; --lane-2: #4d94ff; --lane-3: #ffffff; 
            --lane-4: #ffdb4d; --lane-5: #b366ff; --lane-6: #ff944d;
        }
        body { margin: 0; padding: 0; background: #000; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; }

        /* –≠–ö–†–ê–ù –¢–í */
        #stadium { display: none; width: 100vw; height: 100vh; flex-direction: column; background: #1a3317; position: relative; }
        
        #race-field { 
            flex: 1; position: relative; overflow: hidden; 
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 30%, #ffffff 30%, #2d5a27 31%);
            perspective: 600px; /* –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–∏–Ω—É –¥–ª—è 3D */
        }

        /* –ù–∞—Å—Ç–æ—è—â–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ –¥–æ—Ä–æ–∂–µ–∫ */
        #tracks-container {
            position: absolute; bottom: -50px; left: 50%; 
            width: 150%; height: 80%; 
            transform: translateX(-50%) rotateX(60deg); /* –ù–∞–∫–ª–æ–Ω –≤—Å–µ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ */
            transform-origin: bottom center;
            display: flex; background: #333;
            border: 10px solid white;
        }
        .lane { flex: 1; border-right: 4px solid rgba(255,255,255,0.5); position: relative; }
        .lane::after { content: ""; position: absolute; top:0; left:0; width:100%; height:10px; background: white; } /* –õ–∏–Ω–∏—è —Ñ–∏–Ω–∏—à–∞ */

        /* –õ–æ—à–∞–¥—å */
        .horse {
            position: absolute; 
            bottom: 0; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            transition: bottom 0.1s linear;
            z-index: 10;
        }
        .horse-emoji { 
            font-size: 6rem; 
            transform: scaleX(-1) rotateX(-20deg); /* –ù–∞–∫–ª–æ–Ω –Ω–∞–µ–∑–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Å–º–æ—Ç—Ä–µ–ª –≤ –Ω–µ–±–æ */
            filter: drop-shadow(0 20px 10px rgba(0,0,0,0.5));
        }
        .horse-label { 
            background: rgba(255,255,255,0.9); color: #000; padding: 5px 15px; 
            border-radius: 10px; font-size: 1.4rem; border: 3px solid #000;
            margin-bottom: -10px; white-space: nowrap;
        }

        /* –ü–û–ë–ï–î–ù–´–ô –≠–ö–†–ê–ù */
        #victory-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; text-align: center;
        }
        .firework { position: absolute; width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 50px 20px gold; animation: explode 1s infinite; }

        @keyframes explode { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(20); opacity: 0; } }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (Lobby, Mobile) –æ—Å—Ç–∞—é—Ç—Å—è –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞ */
        #lobby { display: none; width: 100vw; height: 100vh; background: radial-gradient(circle, #4a0000 0%, #000 100%); flex-direction: column; align-items: center; justify-content: center; }
        .qr-container { background: white; padding: 15px; border-radius: 10px; margin: 20px; }
        #countdown-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; font-size: 15rem; color: var(--kr-gold); z-index: 500; }
        
        #mobile { display: none; height: 100vh; background: #1b5e20; text-align: center; padding-top: 30px; }
        .setup-input { padding: 15px; width: 80%; font-size: 1.2rem; margin: 10px 0; border-radius: 10px; border: none; }
        #energy-bar { width: 85%; height: 40px; background: #222; border-radius: 20px; margin: 20px auto; border: 3px solid white; overflow: hidden; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, gold, orange, red); transition: 0.1s; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color: var(--kr-gold); font-size: 3rem;">–£–†–ê–õ–¨–°–ö–ò–ï –°–ö–ê–ß–ö–ò 2026</h1>
        <div class="qr-container" id="player-qr"></div>
        <div id="team-list" style="display:flex; gap:10px;"></div>
    </div>

    <div id="stadium">
        <div id="race-field">
            <div id="tracks-container">
                <div class="lane" style="background:var(--lane-1)"></div>
                <div class="lane" style="background:var(--lane-2)"></div>
                <div class="lane" style="background:var(--lane-3)"></div>
                <div class="lane" style="background:var(--lane-4)"></div>
                <div class="lane" style="background:var(--lane-5)"></div>
                <div class="lane" style="background:var(--lane-6)"></div>
            </div>
            <div id="horses-layer" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none;"></div>
        </div>
    </div>

    <div id="victory-screen">
        <div class="firework" style="top:20%; left:30%;"></div>
        <div class="firework" style="top:40%; left:70%;"></div>
        <h1 style="font-size: 5rem; color: var(--kr-gold); text-shadow: 0 0 30px red;">–ü–û–ë–ï–î–ò–¢–ï–õ–¨</h1>
        <h2 id="winner-name" style="font-size: 7rem; margin: 0;"></h2>
        <button onclick="location.reload()" style="margin-top:50px; padding:20px; font-size:1.5rem;">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
    </div>

    <div id="mobile">
        <div id="m-setup">
            <h1>–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h1>
            <input type="number" id="m-table" class="setup-input" placeholder="–ù–û–ú–ï–† –°–¢–û–õ–ê">
            <input type="text" id="m-name" class="setup-input" placeholder="–ö–û–ú–ê–ù–î–ê">
            <button onclick="mJoin()" style="background:var(--kr-gold); padding:20px; border-radius:10px; font-size:1.5rem;">–ì–û–¢–û–í!</button>
        </div>
        <div id="m-wait" style="display:none;">
            <h2 id="m-team-display"></h2>
            <div id="energy-bar"><div id="energy-fill"></div></div>
            <p>–¢–†–Ø–°–ò –¢–ï–õ–ï–§–û–ù –ü–û–°–õ–ï –°–¢–ê–†–¢–ê!</p>
        </div>
    </div>

    <div id="countdown-overlay">5</div>
    
    <div id="admin-panel" style="position:fixed; bottom:10px; left:10px; display:none; z-index:2000;">
        <button onclick="socket.emit('adminStartCountdown')" style="padding:20px; background:red; color:white;">–°–¢–ê–†–¢</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.has('admin');
        const isScreen = urlParams.has('screen');
        const socket = io({ query: { admin: isAdmin } });

        if (isScreen) {
            document.getElementById('lobby').style.display = 'flex';
            new QRCode(document.getElementById("player-qr"), window.location.origin);
        } else {
            document.getElementById('mobile').style.display = 'block';
        }
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';

        function mJoin() {
            const tableId = document.getElementById('m-table').value;
            const teamName = document.getElementById('m-name').value;
            if(!tableId) return alert("–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–ª");
            socket.emit('join', { tableId, teamName });
            document.getElementById('m-setup').style.display = 'none';
            document.getElementById('m-wait').style.display = 'block';
            document.getElementById('m-team-display').innerText = teamName || "–°—Ç–æ–ª "+tableId;

            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission();
            }
            window.addEventListener('devicemotion', (e) => {
                let acc = e.accelerationIncludingGravity;
                if (Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z) > 22) {
                    socket.emit('shake');
                    document.getElementById('energy-fill').style.width = '100%';
                    setTimeout(() => document.getElementById('energy-fill').style.width = '0%', 100);
                }
            });
        }

        socket.on('updateState', (state) => {
            if (!isScreen) return;

            if (state.status === 'LOBBY') {
                document.getElementById('team-list').innerHTML = Object.values(state.tables).map(t => `<div style="background:gold; color:black; padding:10px;">${t.name}</div>`).join('');
            }

            if (state.status === 'COUNTDOWN' && document.getElementById('countdown-overlay').style.display !== 'flex') {
                startCountdown();
            }

            if (state.status === 'RACING') {
                document.getElementById('stadium').style.display = 'flex';
                document.getElementById('lobby').style.display = 'none';
                renderHorses(state.tables);
            }
        });

        function startCountdown() {
            const overlay = document.getElementById('countdown-overlay');
            overlay.style.display = 'flex';
            let c = 5;
            overlay.innerText = c;
            const t = setInterval(() => {
                c--;
                overlay.innerText = c;
                if (c <= 0) {
                    clearInterval(t);
                    overlay.style.display = 'none';
                    if (isAdmin) socket.emit('adminSetRacing');
                }
            }, 1000);
        }

        function renderHorses(tables) {
            const layer = document.getElementById('horses-layer');
            layer.innerHTML = '';
            Object.values(tables).forEach(t => {
                const laneIdx = (parseInt(t.id) - 1) % 6;
                const progress = t.score / 100;

                // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã:
                // –ü–æ –º–µ—Ä–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –≤–ø–µ—Ä–µ–¥ (progress), –ª–æ—à–∞–¥—å –¥–æ–ª–∂–Ω–∞ —Å–±–ª–∏–∂–∞—Ç—å—Å—è –∫ —Ü–µ–Ω—Ç—Ä—É
                const startX = (laneIdx + 0.5) * (100 / 6);
                const horizonX = 50; // –¢–æ—á–∫–∞ —Å—Ö–æ–¥–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
                const currentX = startX + (horizonX - startX) * (progress * 0.8);

                // –ü–æ –º–µ—Ä–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –≤–ø–µ—Ä–µ–¥, –ª–æ—à–∞–¥—å –¥–æ–ª–∂–Ω–∞ –ø–æ–¥–Ω–∏–º–∞—Ç—å—Å—è –∫ –ª–∏–Ω–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ (30% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞)
                const startY = 90; // –ù–∏–∑ —ç–∫—Ä–∞–Ω–∞
                const horizonY = 32; // –õ–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
                const currentY = startY - (startY - horizonY) * progress;

                const div = document.createElement('div');
                div.className = 'horse';
                div.style.left = currentX + '%';
                div.style.top = currentY + '%';
                // –£–º–µ–Ω—å—à–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø–æ –º–µ—Ä–µ —É–¥–∞–ª–µ–Ω–∏—è
                div.style.transform = `translateX(-50%) scale(${1.3 - (progress * 0.8)})`;

                div.innerHTML = `
                    <div class="horse-label">${t.name}</div>
                    <div class="horse-emoji">üèá</div>
                `;
                layer.appendChild(div);
            });
        }

        socket.on('winner', (data) => {
            document.getElementById('victory-screen').style.display = 'flex';
            document.getElementById('winner-name').innerText = data.name;
        });

        socket.on('gameRestarted', () => location.reload());
    </script>
</body>
</html>
