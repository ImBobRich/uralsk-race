<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—Ä–∞–ª—å—Å–∫–∏–µ –°–∫–∞—á–∫–∏ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --kr-red: #b22222; --kr-gold: #ffd700;
            --lane-1: #ff4d4d; --lane-2: #4d94ff; --lane-3: #ffffff; 
            --lane-4: #ffdb4d; --lane-5: #b366ff; --lane-6: #ff944d;
        }
        body { margin: 0; padding: 0; background: #000; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; }

        /* –ó–ê–°–¢–ê–í–ö–ê (LOBBY) */
        #lobby { 
            display: none; width: 100vw; height: 100vh; 
            background: radial-gradient(circle, #4a0000 0%, #000 100%);
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .kr-border { border: 10px double var(--kr-gold); padding: 40px; background: rgba(0,0,0,0.5); border-radius: 20px; position: relative; }
        .qr-container { background: white; padding: 15px; border-radius: 10px; margin: 20px; display: inline-block; }
        #team-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px; }
        .team-card { background: var(--kr-gold); color: black; padding: 10px 20px; border-radius: 5px; font-size: 1.5rem; animation: pop 0.3s ease-out; }

        /* –°–¢–ê–î–ò–û–ù (RACE) */
        #stadium { display: none; width: 100vw; height: 100vh; flex-direction: column; background: #1a3317; }
        #race-field { flex: 1; position: relative; overflow: hidden; background: linear-gradient(to bottom, #4facfe 0%, #ffffff 35%, #2d5a27 35%); }
        #tracks-layer {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 65%; display: flex; clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
            background: #444; border-top: 10px solid white;
        }
        .lane { flex: 1; border-right: 2px solid rgba(255,255,255,0.3); }

        /* –û–¢–°–ß–ï–¢ */
        #countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center;
            font-size: 15rem; color: var(--kr-gold); z-index: 100;
        }

        /* –ú–û–ë–ò–õ–ö–ê */
        #mobile { display: none; height: 100vh; background: #1b5e20; text-align: center; padding-top: 30px; }
        .setup-input { padding: 15px; width: 80%; font-size: 1.2rem; margin: 10px 0; border-radius: 10px; border: none; }
        #energy-bar { width: 85%; height: 40px; background: #222; border-radius: 20px; margin: 20px auto; border: 3px solid white; overflow: hidden; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, gold, orange, red); transition: 0.1s; }

        /* –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ */
        #admin-panel { position: fixed; bottom: 10px; left: 10px; z-index: 200; display: none; }
        .admin-btn { background: red; color: white; padding: 15px; border: none; font-weight: bold; border-radius: 10px; }

        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
        .horse { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); transition: bottom 0.1s linear; display: flex; flex-direction: column; align-items: center; }
        .horse-emoji { font-size: 5rem; transform: scaleX(-1); }
    </style>
</head>
<body>

    <div id="lobby">
        <div class="kr-border">
            <h1 style="color: var(--kr-gold); font-size: 3.5rem; margin: 0;">2026: –ì–û–î –û–ì–ù–ï–ù–ù–û–ô –õ–û–®–ê–î–ò</h1>
            <h2 style="color: white;">–°–∫–∞–Ω–∏—Ä—É–π QR, –≤—ã–±–∏—Ä–∞–π —Å—Ç–æ–ª –∏ –∂–º–∏ "–ì–û–¢–û–í"</h2>
            
            <div style="display: flex; align-items: center; justify-content: center;">
                <div class="qr-container" id="player-qr"></div>
                <div style="text-align: left; margin-left: 20px;">
                    <p>1. –í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞</p>
                    <p>2. –ü—Ä–∏–¥—É–º–∞–π –∏–º—è –∫–æ–º–∞–Ω–¥—ã</p>
                    <p>3. –¢—Ä—è—Å–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ —Å—Ç–∞—Ä—Ç–µ!</p>
                </div>
            </div>

            <div id="team-list"></div>
        </div>
    </div>

    <div id="stadium">
        <div id="race-field">
            <div id="tracks-layer">
                <div class="lane" style="background:var(--lane-1)"></div><div class="lane" style="background:var(--lane-2)"></div>
                <div class="lane" style="background:var(--lane-3)"></div><div class="lane" style="background:var(--lane-4)"></div>
                <div class="lane" style="background:var(--lane-5)"></div><div class="lane" style="background:var(--lane-6)"></div>
            </div>
            <div id="horses-container" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 65%;"></div>
        </div>
    </div>

    <div id="mobile">
        <div id="m-setup">
            <h1>–£–ß–ê–°–¢–ò–ï</h1>
            <input type="number" id="m-table" class="setup-input" placeholder="‚Ññ –°–¢–û–õ–ê">
            <input type="text" id="m-name" class="setup-input" placeholder="–ù–ê–ó–í–ê–ù–ò–ï –ö–û–ú–ê–ù–î–´">
            <button onclick="mJoin()" style="background:var(--kr-gold); padding:20px 40px; font-size:1.5rem; border-radius:10px;">–ì–û–¢–û–í!</button>
        </div>
        <div id="m-wait" style="display:none;">
            <h2 id="m-team-display"></h2>
            <p>–ñ–¥–µ–º –∫–æ–º–∞–Ω–¥—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...</p>
            <div id="energy-bar"><div id="energy-fill"></div></div>
        </div>
    </div>

    <div id="admin-panel">
        <button class="admin-btn" onclick="adminStart()">–ó–ê–ü–£–°–¢–ò–¢–¨ –°–¢–ê–†–¢ (5 —Å–µ–∫)</button>
        <button class="admin-btn" style="background:blue;" onclick="socket.emit('restart')">–°–ë–†–û–°</button>
    </div>

    <div id="countdown-overlay">5</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.has('admin');
        const isScreen = urlParams.has('screen');
        const socket = io({ query: { admin: isAdmin } });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
        if (isScreen) {
            document.getElementById('lobby').style.display = 'flex';
            new QRCode(document.getElementById("player-qr"), window.location.origin);
        } else {
            document.getElementById('mobile').style.display = 'block';
        }
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';

        // –õ–æ–≥–∏–∫–∞ –º–æ–±–∏–ª–∫–∏
        function mJoin() {
            const tableId = document.getElementById('m-table').value;
            const teamName = document.getElementById('m-name').value;
            if(!tableId) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–ª");
            
            socket.emit('join', { tableId, teamName });
            document.getElementById('m-setup').style.display = 'none';
            document.getElementById('m-wait').style.display = 'block';
            document.getElementById('m-team-display').innerText = teamName || "–°—Ç–æ–ª "+tableId;
            
            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞
            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission();
            }
            window.addEventListener('devicemotion', (e) => {
                let a = e.accelerationIncludingGravity;
                if (Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z) > 25) {
                    socket.emit('shake');
                    document.getElementById('energy-fill').style.width = '100%';
                    setTimeout(() => document.getElementById('energy-fill').style.width = '0%', 150);
                }
            });
        }

        // –õ–æ–≥–∏–∫–∞ –∞–¥–º–∏–Ω–∞
        function adminStart() {
            socket.emit('adminStartCountdown');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        socket.on('updateState', (state) => {
            if (isScreen) {
                if (state.status === 'LOBBY') {
                    const list = document.getElementById('team-list');
                    list.innerHTML = Object.values(state.tables).map(t => `<div class="team-card">${t.name}</div>`).join('');
                }
                
                if (state.status === 'COUNTDOWN') {
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('stadium').style.display = 'flex';
                    startCountdown();
                }

                if (state.status === 'RACING' || state.status === 'FINISHED') {
                    drawRace(state.tables);
                }
            }
        });

        function startCountdown() {
            const overlay = document.getElementById('countdown-overlay');
            overlay.style.display = 'flex';
            let count = 5;
            const timer = setInterval(() => {
                count--;
                overlay.innerText = count;
                if (count <= 0) {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    if(isAdmin) socket.emit('adminSetRacing');
                }
            }, 1000);
        }

        function drawRace(tables) {
            const container = document.getElementById('horses-container');
            container.innerHTML = '';
            Object.entries(tables).forEach(([id, data]) => {
                const laneIdx = (parseInt(id)-1) % 6;
                const progress = data.score / 100;
                const horse = document.createElement('div');
                horse.className = 'horse';
                horse.style.bottom = data.score + '%';
                // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ X-–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è 3D
                const startX = (laneIdx + 0.5) * (100/6);
                const endX = 20 + (laneIdx + 0.5) * 10;
                const currentX = startX + (endX - startX) * progress;
                horse.style.left = currentX + '%';
                horse.style.transform = `translateX(-50%) scale(${1.5 - progress})`;
                
                horse.innerHTML = `<div style="background:white; color:black; padding:2px 10px; border-radius:5px;">${data.name}</div><div class="horse-emoji">üèá</div>`;
                container.appendChild(horse);
            });
        }

        socket.on('winner', (d) => alert("–ü–û–ë–ï–î–ò–õ–ò: " + d.name));
        socket.on('gameRestarted', () => location.reload());
    </script>
</body>
</html>
