<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—Ä–∞–ª—å—Å–∫–∏–µ –°–∫–∞—á–∫–∏ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --kr-red: #b22222; --kr-gold: #ffd700;
            --lane-1: #ff4d4d; --lane-2: #4d94ff; --lane-3: #ffffff; 
            --lane-4: #ffdb4d; --lane-5: #b366ff; --lane-6: #ff944d;
        }
        body { margin: 0; padding: 0; background: #000; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; }

        /* LOBBY */
        #lobby { 
            display: none; width: 100vw; height: 100vh; 
            background: radial-gradient(circle, #4a0000 0%, #000 100%);
            flex-direction: column; align-items: center; justify-content: center; 
        }
        .qr-box { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        #team-list { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; max-width: 80%; }
        .team-tag { background: var(--kr-gold); color: #000; padding: 15px 25px; border-radius: 8px; font-weight: bold; font-size: 1.5rem; animation: pop 0.3s ease-out; }
        @keyframes pop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* STADIUM */
        #stadium { display: none; width: 100vw; height: 100vh; flex-direction: column; background: #1a3317; position: relative; }
        #race-field { 
            flex: 1; position: relative; overflow: hidden; 
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 30%, #ffffff 30%, #2d5a27 31%);
            perspective: 1200px;
        }
        #tracks-container {
            position: absolute; bottom: -15%; left: 50%; width: 150%; height: 85%; 
            transform: translateX(-50%) rotateX(65deg); transform-origin: bottom center;
            display: flex; background: #444; border: 15px solid white;
        }
        .lane { flex: 1; border-right: 5px solid rgba(255,255,255,0.4); }

        /* HORSE */
        .horse {
            position: absolute; transform: translateX(-50%) translateY(-50%);
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 100;
        }
        .horse-emoji { font-size: 5rem; transform: scaleX(-1); filter: drop-shadow(0 15px 10px rgba(0,0,0,0.6)); }
        .horse-label { 
            background: white; color: #000; padding: 5px 15px; border-radius: 10px; 
            font-size: 1.3rem; border: 3px solid #000; margin-bottom: -10px; white-space: nowrap; font-weight: bold;
        }

        /* OVERLAYS */
        #countdown-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center;
            font-size: 25rem; color: var(--kr-gold); z-index: 5000; text-shadow: 0 0 40px #000;
        }
        #victory-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
        }

        /* MOBILE */
        #mobile { display: none; height: 100vh; background: #1b5e20; text-align: center; padding: 20px; box-sizing: border-box; }
        .m-input { width: 100%; padding: 20px; font-size: 1.5rem; border-radius: 10px; border: none; margin: 10px 0; box-sizing: border-box; }
        #energy-bar { width: 100%; height: 50px; background: #222; border-radius: 25px; margin: 25px auto; border: 4px solid white; overflow: hidden; }
        #energy-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff0, #f00); transition: 0.1s; }
        
        /* ADMIN */
        #admin-panel { position: fixed; bottom: 20px; left: 20px; z-index: 10000; display: none; }
        .admin-btn { padding: 20px 40px; background: #f00; color: #fff; border-radius: 10px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color: var(--kr-gold); font-size: 3.5rem; margin-bottom: 20px;">–°–û–õ–¨–ù–ê–õ–¨ 2026: –£–†–ê–õ–¨–°–ö–ò–ï –°–ö–ê–ß–ö–ò</h1>
        <div class="qr-box" id="player-qr"></div>
        <h2 style="color: white; margin-bottom: 40px;">–†–ï–ì–ò–°–¢–†–ò–†–£–ô–¢–ï –°–í–û–ò –°–¢–û–õ–´!</h2>
        <div id="team-list"></div>
    </div>

    <div id="stadium">
        <div id="race-field">
            <div id="tracks-container">
                <div class="lane" style="background:var(--lane-1)"></div>
                <div class="lane" style="background:var(--lane-2)"></div>
                <div class="lane" style="background:var(--lane-3)"></div>
                <div class="lane" style="background:var(--lane-4)"></div>
                <div class="lane" style="background:var(--lane-5)"></div>
                <div class="lane" style="background:var(--lane-6)"></div>
            </div>
            <div id="horses-layer" style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>
        </div>
        <div id="countdown-overlay">5</div>
    </div>

    <div id="victory-screen">
        <h1 style="color: gold; font-size: 6rem;">–ü–û–ë–ï–î–ò–¢–ï–õ–¨!</h1>
        <div id="winner-name" style="font-size: 8rem; margin: 20px 0;"></div>
        <button onclick="socket.emit('restart')" style="padding:20px 50px; font-size: 2rem; border-radius: 15px; cursor: pointer; background: gold;">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
    </div>

    <div id="mobile">
        <div id="m-setup">
            <h1 style="color: gold; font-size: 2.5rem;">–í–ê–® –°–¢–û–õ?</h1>
            <input type="number" id="m-table" class="m-input" placeholder="–ù–û–ú–ï–† –°–¢–û–õ–ê (1-7)">
            <input type="text" id="m-name" class="m-input" placeholder="–ò–ú–Ø –ö–û–ú–ê–ù–î–´">
            <button onclick="mJoin()" style="background: gold; padding: 25px; width: 100%; border-radius: 15px; font-size: 2rem; border: none; margin-top: 20px; font-weight: bold;">–ì–û–¢–û–í!</button>
        </div>
        <div id="m-race" style="display:none;">
            <h1 id="m-team-name" style="color: gold; font-size: 2.5rem; margin-bottom: 0;"></h1>
            <div id="energy-bar"><div id="energy-fill"></div></div>
            <h2 id="m-status" style="font-size: 1.8rem;">–ñ–î–ï–ú –°–¢–ê–†–¢–ê...</h2>
        </div>
    </div>

    <div id="admin-panel">
        <button class="admin-btn" onclick="socket.emit('adminStartCountdown')">–°–¢–ê–†–¢ –ì–û–ù–ö–ò</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const isAdmin = params.has('admin');
        const isScreen = params.has('screen');
        const socket = io({ query: { admin: isAdmin } });

        if (isScreen) {
            document.getElementById('lobby').style.display = 'flex';
            new QRCode(document.getElementById("player-qr"), window.location.origin);
        } else {
            document.getElementById('mobile').style.display = 'block';
        }
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';

        function mJoin() {
            const tableId = document.getElementById('m-table').value;
            const teamName = document.getElementById('m-name').value;
            if(!tableId) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞!");
            
            socket.emit('join', { tableId, teamName });
            document.getElementById('m-setup').style.display = 'none';
            document.getElementById('m-race').style.display = 'block';
            document.getElementById('m-team-name').innerText = teamName || "–°—Ç–æ–ª "+tableId;

            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission();
            }
            window.addEventListener('devicemotion', (e) => {
                let a = e.accelerationIncludingGravity;
                let force = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);
                if (force > 25) {
                    socket.emit('shake');
                    document.getElementById('energy-fill').style.width = '100%';
                    setTimeout(() => document.getElementById('energy-fill').style.width = '0%', 100);
                }
            });
        }

        socket.on('updateState', (state) => {
            if (isScreen) {
                if (state.status === 'LOBBY') {
                    document.getElementById('lobby').style.display = 'flex';
                    document.getElementById('stadium').style.display = 'none';
                    document.getElementById('victory-screen').style.display = 'none';
                    
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–æ–≤
                    const list = document.getElementById('team-list');
                    list.innerHTML = '';
                    Object.values(state.tables).forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'team-tag';
                        div.innerText = t.name;
                        list.appendChild(div);
                    });
                }
                
                if (state.status === 'COUNTDOWN' || state.status === 'RACING' || state.status === 'FINISHED') {
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('stadium').style.display = 'flex';
                    renderHorses(state.tables);
                    
                    const ov = document.getElementById('countdown-overlay');
                    if (state.status === 'COUNTDOWN') {
                        ov.style.display = 'flex';
                    } else {
                        ov.style.display = 'none';
                    }
                }
            } else {
                const statusText = document.getElementById('m-status');
                if (state.status === 'RACING') statusText.innerText = "–¢–†–Ø–°–ò –¢–ï–õ–ï–§–û–ù!!!";
                if (state.status === 'FINISHED') statusText.innerText = "–§–ò–ù–ò–®!";
            }
        });

        function renderHorses(tables) {
            const layer = document.getElementById('horses-layer');
            layer.innerHTML = '';
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç–æ–ª–∞–º –≤ –æ–±—ä–µ–∫—Ç–µ –∏ —Ä–∏—Å—É–µ–º –∫–∞–∂–¥–æ–≥–æ
            Object.values(tables).forEach(t => {
                const laneIdx = (parseInt(t.id) - 1) % 6;
                const progress = t.score / 100;
                
                const startX = (laneIdx + 0.5) * (100 / 6);
                const horizonX = 50; 
                const currentX = startX + (horizonX - startX) * (progress * 0.85);
                const currentY = 85 - (85 - 32) * progress;

                const div = document.createElement('div');
                div.className = 'horse';
                div.style.left = currentX + '%';
                div.style.top = currentY + '%';
                
                const scale = 1.7 - (progress * 1.0);
                div.style.transform = `translateX(-50%) translateY(-50%) scale(${scale})`;
                div.style.zIndex = Math.floor(200 - t.score);

                div.innerHTML = `
                    <div class="horse-label">${t.name}</div>
                    <div class="horse-emoji">üèá</div>
                `;
                layer.appendChild(div);
            });
        }

        socket.on('winner', (data) => {
            if (isScreen) {
                document.getElementById('victory-screen').style.display = 'flex';
                document.getElementById('winner-name').innerText = data.name;
            }
        });

        socket.on('gameRestarted', () => location.reload());
    </script>
</body>
</html>
